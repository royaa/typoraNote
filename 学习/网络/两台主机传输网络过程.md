# 传输过程中 ip mac地址变化

场景 pc A -- (路由器 B1, B2) -- (路由器 C1, C2) -- pc D

A向D发送数据包：

* 源ip： A的ip
* 源mac: A的mac
* 目标ip: D的ip
* 目标mac: D的mac

因为中间经过B和C路由器，所以在传输过程中源ip和目标ip是不会变的，但是mac地址会发生变化

当经过B路由时

* 源mac: B2的mac地址

* 目标mac: C1的mac地址

当经过C路由时

* 源mac: C2的mac地址
* 目标mac: D的mac地址

D响应时，是逆向过程对调一下



# dns解析ip

访问网络，我们都是域名访问，所以需要经过dns服务解析出最近的ip地址



# arp解析mac

在以太网中，主机之间是通过mac地址访问的，当我们知道ip后需要通过arp来获取mac地址

以ftp为例：

1. 应用层： ftp登录 用户名、密码
2. 传输层： 目的端口 21， 源端口 随机
3. 网络层： 目的ip 192.168.10.200   源ip  192.168.10.201
4. 数据链路层：因为不知道192.168.10.200的mac地址，所以目的ip到目的mac映射失败，三层到二层的封装失败。由于二层是以太网，所以会启动arp广播，源mac地址为数据发起者的mac，目的mac为FFFF:FFFF:FFFF:FFFF
5. 当本网段所有机器收到arp请求时，发现是FFFF:FFFF:FFFF:FFFF时，所有设备都会去解包的封装，解读目的ip，如果发现不是自己的ip, 就会丢弃这个arp请求包，如果发现是自己的ip, 就会响应回去，此时源mac地址为自己的mac， 目的mac为发起者mac
6. 发起者接收到arp响应时，会将目的ip与目的mac对应关系存储到apr缓存表中
7. 之前二层封装失败，此时已经取到mac地址，重新开始封装二层头，完成了封装的数据帧，可以正常发出去了



# 交换机案例

1. PC A  --  交换机 f0/1   0/2   -- PC B
   * 主机A 发送一个源mac为自己，目标mac地址为主机B的数据帧发送给交换机
   * 交换机收到此数据帧后，首先将数据帧中的源MAC地址和对应的接口(接口为f 0/1) 记录到MAC地址表中。
   * 然后交换机会检查自己的MAC地址表中是否有数据帧中的目标MAC地址的信息，如果有，则从MAC地址表中记录的接口发送出去，如果没有，则会将此数据帧从非接收接口的所有接口发送出去(也就是除了f 0/1接口）
   * 这时，局域网的所有主机都会收到此数据帧，但是只有主机B收到此数据帧时会响应这个广播，并回应一个数据帧，此数据帧中包括主机B的MAC地址。
   * 当交换机收到主机B回应的数据帧后，也会记录数据帧中的源MAC地址(也就是主机B的MAC地址)，这时，再当主机A和主机B通信时，交换机根据MAC地址表中的记录，实现单播了。





# 概念

## mac

MAC地址的长度为48位（6个字节），通常表示为12个16进制数，每2个16进制数之间用冒号隔开，如：08:00:20:0A:8C:6D就是一个MAC地址，其中前6位16进制数08:00:20代表网络硬件制造商的编号，它由IEEE（Istitute of Electrical and Electronics Engineers，电气与电子工程师协会）分配，而后3位16进制数0A:8C:6D代表该制造商所制造的某个网络产品（如网卡）的系列号。每个网络制造商必须确保它所制造的每个以太网设备都具有相同的前三字节以及不同的后三个字节。这样就可保证世界上每个以太网设备都具有唯一的MAC地址。

## arp

ARP报文不是直接在网络层上发送的，它还是需要向下传输到数据链路层，所以当ARP报文传输到数据链路层之后，需要再次进行封装。以以太网为例，ARP报文传输到以太网数据链路层后会形成ARP帧。ARP帧如下图所示，他就是在ARP报文前面加了一个以太网帧头。

<table>
  <tr>
  	<th colspan="3">以太网帧头</th>
    <th colspan="5">arp报头</th>
    <th colspan="4"></th>
  </tr>
  <tr>
    <td>目的mac地址</td>
    <td>源mac地址</td>
		<td>帧类型</td>
    <td>硬件类型</td>
    <td>上层协议类型</td>
    <td>mac地址长度</td>
    <td>ip地址长度</td>
    <td>操作类型</td>
    <td>源mac地址</td>
    <td>源ip地址</td>
    <td>目的mac地址</td>
    <td>目的ip地址</td>
  </tr>
</table>



## 交换机

交换机在接收到数据帧以后，首先、会记录数据帧中的源MAC地址和对应的接口到MAC表中，接着、会检查自己的MAC表中是否有数据帧中目标MAC地址的信息，如果有则会根据MAC表中记录的对应接口将数据帧发送出去(也就是单播)，如果没有，则会将该数据帧从非接受接口发送出去(也就是广播)。